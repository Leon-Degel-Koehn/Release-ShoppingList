<!DOCTYPE html>
<html>
    <head>
        <style>
            div {
                height: 100vh;
                width: 100vw;
            }
        </style>
    </head>
    <body>

        <div id="displayDiv"></div>
        
        <script src="quagga.min.js"></script>
        
        <script>

            async function getProductFromCode(barcode) {
                //nach q= kommt der barcode
                let text = await fetch(`https://api.codetabs.com/v1/proxy?quest=https://go-upc.com/search?q=${barcode}`)
                .then((response) => response.text());
                let myRegex = /<h1.*class="product-name".*>/;
                if(text.indexOf("Sorry, we were not able to find a product") >= 0)
                    return "leider ein unbekannter Artikel";
                let res = text.match(myRegex)[0];
                let ind1 = res.indexOf('>');
                text = res.substring(ind1+1, res.indexOf('<', ind1));
                return text;
            }


        </script>
        <script>
            Quagga.init({
                inputStream : {
                    name : "Live",
                    type : "LiveStream",
                    target: document.getElementById('displayDiv'), 
                    constraints: {
                        height: window.innerHeight,
                        width: window.innerWidth
                    }
                },
                decoder : {
                    readers : ["ean_reader", "code_128_reader", "code_39_reader"]
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    return
                }
                console.log("Initialization finished. Ready to start");

                Quagga.start();
            });

            
            Quagga.onDetected((data) => {
                
                //we have detected a barcode in the livestream
                const barcode = data["codeResult"]["code"];
                console.log("detected barcode");
                (async () => {
                    let text = await getProductFromCode(barcode);
                    alert(text);
                })();
            });
            


        </script>
    </body>
</html>